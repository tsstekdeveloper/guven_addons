<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güven Hastanesi - E-Fatura Analiz Modülü Teknik Raporu</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #34495e;
            --border: #bdc3c7;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --text: #2c3e50;
            --text-muted: #7f8c8d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text);
            line-height: 1.6;
            background: var(--bg-light);
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 32px;
        }

        /* Header */
        .report-header {
            background: var(--primary);
            color: white;
            padding: 48px 0;
            margin-bottom: 40px;
        }

        .report-header .container {
            padding-top: 0;
            padding-bottom: 0;
        }

        .report-header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .report-header .subtitle {
            font-size: 16px;
            opacity: 0.85;
            font-weight: 300;
        }

        .report-meta {
            margin-top: 20px;
            font-size: 13px;
            opacity: 0.7;
        }

        .report-meta span { margin-right: 24px; }

        /* Section */
        .section {
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .section h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .section h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--accent);
            margin: 20px 0 10px 0;
        }

        .section h3:first-of-type { margin-top: 0; }

        p, li { font-size: 14px; }
        p { margin-bottom: 10px; }

        /* Metric Cards */
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }

        .metric-card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .metric-card .label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin: 12px 0;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--accent);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        tr:hover td { background: #fafbfc; }

        td.mono {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
        }

        td.num { text-align: right; font-variant-numeric: tabular-nums; }

        /* Lists */
        ul { padding-left: 20px; margin: 8px 0; }
        li { margin-bottom: 4px; }

        /* Architecture Diagram */
        .arch-diagram {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 24px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre;
            margin: 12px 0;
        }

        /* Two column layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Tag */
        .tag {
            display: inline-block;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 2px 8px;
            font-size: 11px;
            font-family: 'Consolas', monospace;
            margin: 2px;
        }

        /* Footer */
        .report-footer {
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            padding: 24px 0;
        }

        @media print {
            body { background: white; }
            .container { padding: 20px; }
            .section { break-inside: avoid; border: 1px solid #ddd; }
            .report-header { padding: 32px 0; }
        }

        @media (max-width: 768px) {
            .metric-grid { grid-template-columns: repeat(2, 1fr); }
            .two-col { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="report-header">
    <div class="container">
        <h1>E-Fatura Analiz Modülü</h1>
        <div class="subtitle">Güven Hastanesi &mdash; Teknik Rapor</div>
        <div class="report-meta">
            <span>Platform: Odoo 19.0</span>
            <span>Modül: guven_fatura_analiz</span>
            <span>Tarih: 25 Şubat 2026</span>
        </div>
    </div>
</div>

<div class="container">

    <!-- 1. Arayüz Özeti -->
    <div class="section">
        <h2>1. Arayüz Özeti</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <span class="value">12</span>
                <span class="label">Menü Öğesi</span>
            </div>
            <div class="metric-card">
                <span class="value">47+</span>
                <span class="label">View Tanımı</span>
            </div>
            <div class="metric-card">
                <span class="value">11</span>
                <span class="label">Wizard</span>
            </div>
            <div class="metric-card">
                <span class="value">4</span>
                <span class="label">Cron Job</span>
            </div>
        </div>

        <h3>Menü Yapısı</h3>
<div class="arch-diagram" style="font-size:12px; line-height:1.7">
Fatura Analiz
 ├── Faturalar
 │    ├── GİB Fatura Listesi
 │    ├── Logo Fatura Listesi
 │    ├── GİB &gt;&gt;&gt; Logo Eşleştirme
 │    └── Logo &gt;&gt;&gt; GİB Eşleştirme
 ├── Raporlar
 │    ├── KDV-2 Listesi
 │    ├── Muhtasar
 │    └── Vergi Analizi
 ├── Veri Güncelleme
 │    ├── izibiz Veri Güncelleme
 │    ├── Logo Veri Güncelleme
 │    ├── E-Arşiv GİB Excel İçeri Al
 │    └── QNB Excel İçeri Al
 └── Şirket Tanımları</div>
    </div>

    <!-- 2. Temel İş Kuralları -->
    <div class="section">
        <h2>2. Temel İş Kuralları</h2>

        <div class="two-col">
            <div>
                <h3>Geçerlilik Hesaplama (gvn_active)</h3>
                <p>Her fatura kaydının geçerliliği otomatik hesaplanır:</p>
                <ul>
                    <li><strong>E-Arşiv:</strong> harici iptal, IPTAL profili, durum kodu 150/200, iptal kaydı bağlantısı kontrolleri</li>
                    <li><strong>E-Fatura:</strong> harici iptal, durum kodu 116/120/130/136 kontrolleri</li>
                </ul>

                <h3>Kayıt Kilitleme</h3>
                <p>Analiz süresince faturaların değiştirilmesini önler. Kilitli kayıtlarda kilit alanları dışında yazma işlemi <span class="tag">UserError</span> fırlatır.</p>

                <h3>İptal Takibi</h3>
                <p>İptal kayıtları orijinal faturaya bağlanır (<span class="tag">cancelled_invoice_id</span>). İptal kaydı olan faturalar otomatik olarak geçersiz sayılır.</p>
            </div>
            <div>
                <h3>Logo Eşleştirme</h3>
                <ul>
                    <li><strong>GİB &rarr; Logo:</strong> invoice_id ile fatura_no_1/fatura_no_2 arasında arama</li>
                    <li><strong>Logo &rarr; GİB:</strong> Ters yönde aynı mantık</li>
                    <li>0 eşleşme: alanlar temizlenir</li>
                    <li>1 eşleşme: detaylar kaydedilir, farklar hesaplanır</li>
                    <li>&gt;1 eşleşme: VKN ile filtreleme uygulanır</li>
                </ul>

                <h3>Veri Dönüşümü</h3>
                <ul>
                    <li>Çoklu tarih formatı parse (ISO, YYYYMMDD, DD/MM/YYYY, DD.MM.YYYY)</li>
                    <li>Türkçe ondalık format (1.234,56 &rarr; 1234.56)</li>
                    <li>Döviz &rarr; TRY dönüşümü (orijinal + TRY ayrı saklanır)</li>
                    <li>VKN 10 hane normalizasyonu</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- 3. Raporlar -->
    <div class="section">
        <h2>3. Raporlar</h2>
        <table>
            <tr><th>Rapor</th><th>Veri Kaynağı</th><th>Görünümler</th><th>Açıklama</th></tr>
            <tr>
                <td>Vergi Analizi</td>
                <td>SQL VIEW<br>(guven_fatura + guven_fatura_tax)</td>
                <td>Graph, Pivot, List</td>
                <td>Aylık vergi kırılımı &mdash; 8 vergi tipi x 6 kategori (Gelen/Giden GİB, Gelen/Giden Logo Eşli, GİB Fark, Logo Fark). Ay ve vergi tipi filtreleri.</td>
            </tr>
            <tr>
                <td>KDV-2</td>
                <td>Logo MSSQL<br>(Modül 2 &mdash; Satınalma)</td>
                <td>List, Form</td>
                <td>Tevkifat oranlarına göre KDV-2 beyanname verileri. Tevkifat kodları: 2/10 &ndash; 10/10.</td>
            </tr>
            <tr>
                <td>Muhtasar</td>
                <td>Logo MSSQL<br>(Modül 2 + Modül 6)</td>
                <td>List, Form, Pivot</td>
                <td>Gelir vergisi stopaj ve muhtasar özet tablosu. Satınalma + Banka modülleri.</td>
            </tr>
            <tr>
                <td>GİB &raquo; Logo Eşleştirme</td>
                <td>guven.fatura</td>
                <td>List</td>
                <td>GİB faturalarının Logo karşılıkları, tutar/tarih/kimlik farkları.</td>
            </tr>
            <tr>
                <td>Logo &raquo; GİB Eşleştirme</td>
                <td>guven.logo.fatura</td>
                <td>List</td>
                <td>Logo faturalarının GİB karşılıkları (ters eşleştirme).</td>
            </tr>
        </table>
    </div>

    <!-- 4. Otomasyon -->
    <div class="section">
        <h2>4. Otomasyon</h2>
        <table>
            <tr><th>Cron</th><th>Aralık</th><th>Varsayılan</th><th>Lock ID</th><th>Açıklama</th></tr>
            <tr>
                <td>Header Senkronizasyonu</td><td>10 dk</td><td>Aktif</td>
                <td class="mono">737003</td>
                <td>E-fatura + e-arşiv header'larını izibiz SOAP'tan çeker. 7 günlük kayan pencere, cursor tabanlı ilerleme.</td>
            </tr>
            <tr>
                <td>E-Fatura Detay Çekme</td><td>2 dk</td><td>Pasif</td>
                <td class="mono">737001</td>
                <td>UBL XML içeriğini çeker, kalem ve vergi detaylarını parse eder.</td>
            </tr>
            <tr>
                <td>E-Arşiv Detay Çekme</td><td>2 dk</td><td>Pasif</td>
                <td class="mono">737002</td>
                <td>E-arşiv kayıtları için detay çekme ve parse.</td>
            </tr>
            <tr>
                <td>Logo MSSQL Sync</td><td>15 dk</td><td>Pasif</td>
                <td class="mono">737004</td>
                <td>Logo faturalarını çeker, çift yönlü eşleştirme yapar. 30 günlük kayan pencere.</td>
            </tr>
        </table>
        <p style="margin-top:12px; color: var(--text-muted); font-size: 13px;">
            Tüm cron job'lar PostgreSQL advisory lock ile korunur; eşzamanlı çalışma engellenir.
        </p>
    </div>

    <!-- 5. Güvenlik Modeli -->
    <div class="section">
        <h2>5. Güvenlik Modeli</h2>

        <div class="two-col">
            <div>
                <h3>Rol Hiyerarşisi</h3>
                <table>
                    <tr><th>Rol</th><th>Yetki</th></tr>
                    <tr><td>Muhasebe Yöneticisi</td><td>Tam CRUD, kilit yönetimi</td></tr>
                    <tr><td>Muhasebe Sorumlusu</td><td>Okuma/yazma, wizard çalıştırma, rapor</td></tr>
                    <tr><td>Muhasebe Uzmanı</td><td>Salt okunur</td></tr>
                    <tr><td>Muhasebe Çalışanı</td><td>Salt okunur</td></tr>
                </table>
                <p style="margin-top:8px; font-size:12px; color:var(--text-muted)">
                    Her üst rol, altındaki rolün yetkilerini miras alır.
                </p>
            </div>
            <div>
                <h3>Erişim Kontrolleri</h3>
                <table>
                    <tr><td>Model erişim kuralları</td><td class="num">50</td></tr>
                    <tr><td>Kayıt kuralları (IR Rule)</td><td class="num">7</td></tr>
                    <tr><td>Güvenlik grupları</td><td class="num">4</td></tr>
                </table>
                <h3>Çok Şirketli İzolasyon</h3>
                <p>Tüm veri modelleri <span class="tag">company_id</span> alanı ve IR rule ile şirket bazlı izole edilir. Kimlik bilgileri (SOAP, MSSQL) şirket bazlı saklanır.</p>
            </div>
        </div>
    </div>

    <!-- 6. Dış Entegrasyonlar -->
    <div class="section">
        <h2>6. Dış Entegrasyonlar</h2>

        <div class="two-col">
            <div>
                <h3>izibiz SOAP</h3>
                <table>
                    <tr><td>Protokol</td><td>SOAP 1.1 / WSDL</td></tr>
                    <tr><td>E-Fatura WS</td><td class="mono" style="font-size:11px">efaturaws.izibiz.com.tr</td></tr>
                    <tr><td>E-Arşiv WS</td><td class="mono" style="font-size:11px">earsivws.izibiz.com.tr</td></tr>
                    <tr><td>Timeout</td><td>90 sn / istek, 3x retry</td></tr>
                    <tr><td>Operasyonlar</td><td>Login, GetInvoiceHeaders, GetInvoiceDetails, Logout</td></tr>
                    <tr><td>Optimizasyon</td><td>HEADER_ONLY=Y (header sync)</td></tr>
                </table>
            </div>
            <div>
                <h3>Logo MSSQL</h3>
                <table>
                    <tr><td>Protokol</td><td>TDS (pymssql)</td></tr>
                    <tr><td>Charset</td><td>cp1254 (Türkçe)</td></tr>
                    <tr><td>Timeout</td><td>30 sn login + 30 sn sorgu</td></tr>
                    <tr><td>Tablolar</td><td class="mono">LG_XXX_01_INVOICE, LG_XXX_CLCARD</td></tr>
                    <tr><td>Kimlik bilgileri</td><td>Şirket bazlı (res.company)</td></tr>
                    <tr><td>Sorgu stratejisi</td><td>DATE_ + DOCDATE UNION (boşluk önleme)</td></tr>
                </table>
            </div>
        </div>

        <h3>Excel İçe Aktarma Formatları</h3>
        <table>
            <tr><th>Kaynak</th><th class="num">Sütun</th><th>İçerik</th><th>Kütüphane</th></tr>
            <tr><td>QNB E-Fatura</td><td class="num">81</td><td>Fatura header + 7 KDV oranı + tevkifat + ÖTV/ÖİV</td><td class="mono">openpyxl</td></tr>
            <tr><td>QNB E-Arşiv</td><td class="num">74</td><td>Fatura header + 6 KDV oranı + tevkifat + ÖTV/ÖİV</td><td class="mono">openpyxl</td></tr>
            <tr><td>GİB E-Arşiv</td><td class="num">13</td><td>Fatura özet (ünvan, tutar, durum, iptal)</td><td class="mono">openpyxl</td></tr>
        </table>
    </div>

    <!-- 7. Mimari -->
    <div class="section">
        <h2>7. Mimari</h2>

        <h3>Veri Modeli</h3>
        <table>
            <tr><th>Model</th><th>Tip</th><th class="num">Alan</th><th>Tablo</th><th>Amaç</th></tr>
            <tr>
                <td class="mono">guven.fatura</td><td>Model</td><td class="num">57</td>
                <td>Persistent</td><td>GİB e-fatura / e-arşiv kayıtları</td>
            </tr>
            <tr>
                <td class="mono">guven.fatura.line</td><td>Model</td><td class="num">11</td>
                <td>Persistent</td><td>Fatura kalem detayları</td>
            </tr>
            <tr>
                <td class="mono">guven.fatura.tax</td><td>Model</td><td class="num">10</td>
                <td>Persistent</td><td>Vergi kırılımları (KDV, tevkifat, BSMV vb.)</td>
            </tr>
            <tr>
                <td class="mono">guven.fatura.note</td><td>Model</td><td class="num">6</td>
                <td>Persistent</td><td>Fatura metadata (key/value)</td>
            </tr>
            <tr>
                <td class="mono">guven.logo.fatura</td><td>Model</td><td class="num">30</td>
                <td>Persistent</td><td>Logo ERP fatura kayıtları</td>
            </tr>
            <tr>
                <td class="mono">guven.vergi.analiz</td><td>Model</td><td class="num">6</td>
                <td>SQL VIEW</td><td>Aylık vergi analizi (rapor)</td>
            </tr>
            <tr>
                <td class="mono">res.company</td><td>Inherit</td><td class="num">20</td>
                <td>Persistent</td><td>Şirket bazlı SOAP/MSSQL kimlik bilgileri</td>
            </tr>
        </table>

        <h3>Wizard'lar (TransientModel)</h3>
        <table>
            <tr><th>Wizard</th><th>Amaç</th></tr>
            <tr><td class="mono">guven.fatura.sync.wizard</td><td>izibiz e-fatura / e-arşiv header senkronizasyonu</td></tr>
            <tr><td class="mono">guven.logo.sync.wizard</td><td>Logo MSSQL senkronizasyon ve eşleştirme</td></tr>
            <tr><td class="mono">guven.qnb.import.wizard / file</td><td>QNB banka Excel içe aktarma (81/74 sütun)</td></tr>
            <tr><td class="mono">guven.earsiv.import.wizard / file</td><td>E-Arşiv GİB Excel içe aktarma (13 sütun)</td></tr>
            <tr><td class="mono">guven.kdv2.wizard / report</td><td>KDV-2 raporu (Logo MSSQL sorgusu)</td></tr>
            <tr><td class="mono">guven.muhtasar.wizard / report</td><td>Muhtasar raporu (Logo MSSQL sorgusu)</td></tr>
            <tr><td class="mono">guven.fatura.lock.wizard</td><td>Fatura kilitleme / kilit açma</td></tr>
        </table>

        <h3>Katman Diyagramı</h3>
<div class="arch-diagram">
Kullanıcı Arayüzü (Odoo Web Client)
 ├── 12 Menü Öğesi  ·  47+ View (List / Form / Graph / Pivot / Search)
 │
Uygulama Katmanı (guven_fatura_analiz)
 ├── Modeller ─── guven.fatura ──┬── guven.fatura.line
 │                               ├── guven.fatura.tax
 │                               └── guven.fatura.note
 │                guven.logo.fatura
 │                guven.vergi.analiz (SQL VIEW)
 │
 ├── Wizard'lar ─ Sync · Import · Rapor · Kilit
 │
 ├── Cron ─────── Header Sync (10dk) · Detail Fetch (2dk) · Logo Sync (15dk)
 │                Advisory Lock ile eşzamanlılık kontrolü
 │
Dış Entegrasyonlar
 ├── izibiz SOAP ──── E-Fatura WS  ·  E-Arşiv WS  (zeep + retry)
 ├── Logo MSSQL ───── Fatura tabloları  ·  Cari kartlar  (pymssql, cp1254)
 └── Excel Import ─── QNB (openpyxl)  ·  GİB E-Arşiv
</div>
    </div>

    <!-- 8. Kod Metrikleri -->
    <div class="section">
        <h2>8. Kod Metrikleri</h2>
        <div class="metric-grid">
            <div class="metric-card">
                <span class="value">9.004</span>
                <span class="label">Toplam Satır</span>
            </div>
            <div class="metric-card">
                <span class="value">6.044</span>
                <span class="label">Efektif Python LOC</span>
            </div>
            <div class="metric-card">
                <span class="value">38</span>
                <span class="label">Dosya</span>
            </div>
            <div class="metric-card">
                <span class="value">140</span>
                <span class="label">Alan Tanımı</span>
            </div>
        </div>

        <div class="two-col">
            <div>
                <h3>Dosya Dağılımı</h3>
                <table>
                    <tr><th>Tip</th><th class="num">Dosya</th><th class="num">Satır</th></tr>
                    <tr><td>Python &mdash; Modeller</td><td class="num">8</td><td class="num">3.082</td></tr>
                    <tr><td>Python &mdash; Wizard'lar</td><td class="num">8</td><td class="num">3.000</td></tr>
                    <tr><td>Python &mdash; Diğer</td><td class="num">5</td><td class="num">162</td></tr>
                    <tr><td>XML &mdash; View / Data</td><td class="num">15</td><td class="num">1.704</td></tr>
                    <tr><td>CSV &mdash; Erişim Kuralları</td><td class="num">1</td><td class="num">50</td></tr>
                    <tr><td>SCSS</td><td class="num">1</td><td class="num">33</td></tr>
                </table>
            </div>
            <div>
                <h3>Bağımlılıklar</h3>
                <table>
                    <tr><th>Tip</th><th>Bağımlılık</th></tr>
                    <tr><td>Odoo Modülleri</td><td><span class="tag">base</span> <span class="tag">account</span> <span class="tag">mail</span></td></tr>
                    <tr><td>Python Kütüphaneleri</td><td><span class="tag">zeep</span> <span class="tag">pymssql</span> <span class="tag">openpyxl</span></td></tr>
                </table>
                <h3>Altyapı</h3>
                <table>
                    <tr><td>Deployment</td><td>Docker (Ubuntu 24.04)</td></tr>
                    <tr><td>Veritabanı</td><td>PostgreSQL 13+</td></tr>
                    <tr><td>Python</td><td>3.10 &ndash; 3.13</td></tr>
                </table>
            </div>
        </div>
    </div>

</div>

<div class="report-footer">
    <div class="container">
        Güven Hastanesi &mdash; E-Fatura Analiz Modülü Teknik Raporu &mdash; Şubat 2026
    </div>
</div>

</body>
</html>
