<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ============================================================ -->
        <!-- SEARCH VIEW                                                   -->
        <!-- ============================================================ -->
        <record id="guven_fatura_view_search" model="ir.ui.view">
            <field name="name">guven.fatura.search</field>
            <field name="model">guven.fatura</field>
            <field name="arch" type="xml">
                <search string="Fatura Arama">
                    <field name="invoice_id" string="Fatura No"/>
                    <field name="uuid"/>
                    <field name="sender_name" string="Gönderen"/>
                    <field name="receiver_name" string="Alıcı"/>
                    <separator/>
                    <filter name="filter_active" string="Geçerli" domain="[('gvn_active', '=', True)]"/>
                    <filter name="filter_incoming" string="Gelen" domain="[('direction', '=', 'IN')]"/>
                    <filter name="filter_outgoing" string="Giden" domain="[('direction', '=', 'OUT')]"/>
                    <separator/>
                    <filter name="filter_efatura" string="E-Fatura" domain="[('kaynak', '=', 'e-fatura')]"/>
                    <filter name="filter_earsiv" string="E-Arşiv" domain="[('kaynak', '=', 'e-arsiv')]"/>
                    <group>
                        <filter name="group_kaynak" string="Kaynak" context="{'group_by': 'kaynak'}"/>
                        <filter name="group_direction" string="Yön" context="{'group_by': 'direction'}"/>
                        <filter name="group_profile" string="Fatura Profili" context="{'group_by': 'profile_id'}"/>
                        <filter name="group_type" string="Fatura Tipi" context="{'group_by': 'invoice_type_code'}"/>
                        <filter name="group_issue_date" string="Fatura Tarihi (Ay)" context="{'group_by': 'issue_date:month'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- LIST VIEW                                                     -->
        <!-- ============================================================ -->
        <record id="guven_fatura_view_list" model="ir.ui.view">
            <field name="name">guven.fatura.list</field>
            <field name="model">guven.fatura</field>
            <field name="arch" type="xml">
                <list string="Faturalar" default_order="issue_date desc, invoice_id desc" decoration-muted="not gvn_active" create="0" delete="0">
                    <field name="invoice_id"/>
                    <field name="issue_date"/>
                    <field name="sender_name"/>
                    <field name="receiver_name"/>
                    <field name="profile_id" optional="show"/>
                    <field name="invoice_type_code" optional="show"/>
                    <field name="payable_amount_try" string="Tutar (TRY)" widget="float" options="{'digits': [16, 2]}"/>
                    <field name="kaynak"/>
                    <field name="direction"/>
                    <field name="details_received" widget="boolean" optional="hide"/>
                    <field name="gvn_active" widget="boolean"/>
                </list>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- FORM VIEW                                                     -->
        <!-- ============================================================ -->
        <record id="guven_fatura_view_form" model="ir.ui.view">
            <field name="name">guven.fatura.form</field>
            <field name="model">guven.fatura</field>
            <field name="arch" type="xml">
                <form string="Fatura" create="0" delete="0">
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="invoice_id" readonly="1"/>
                            </h1>
                        </div>
                        <notebook>
                            <!-- Genel Bilgiler + Taraf Bilgileri -->
                            <page string="Genel" name="general">
                                <group>
                                    <group string="Genel Bilgiler">
                                        <field name="uuid" readonly="1"/>
                                        <field name="issue_date" readonly="1"/>
                                        <field name="issue_time" readonly="1"/>
                                        <field name="kaynak" readonly="1"/>
                                        <field name="direction" readonly="1"/>
                                        <field name="profile_id" readonly="1"/>
                                        <field name="invoice_type_code" readonly="1"/>
                                        <field name="company_id" readonly="1" groups="base.group_multi_company"/>
                                    </group>
                                    <group string="Taraf Bilgileri">
                                        <field name="sender" readonly="1"/>
                                        <field name="sender_name" readonly="1"/>
                                        <field name="receiver" readonly="1"/>
                                        <field name="receiver_name" readonly="1"/>
                                    </group>
                                </group>
                            </page>
                            <!-- Tutarlar -->
                            <page string="Tutarlar" name="amounts">
                                <group>
                                    <group string="Tutar (Döviz)">
                                        <field name="currency_code" readonly="1"/>
                                        <field name="exchange_rate" readonly="1" widget="float" options="{'digits': [16, 8]}"/>
                                        <field name="tax_exclusive_amount" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="tax_inclusive_amount" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="allowance_total_amount" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="payable_amount" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                    </group>
                                    <group string="Tutar (TRY)">
                                        <field name="tax_exclusive_amount_try" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="tax_inclusive_amount_try" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="allowance_total_amount_try" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="payable_amount_try" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                    </group>
                                </group>
                            </page>
                            <!-- Kalemler -->
                            <page string="Kalemler" name="lines">
                                <field name="line_ids" readonly="1">
                                    <list>
                                        <field name="line_no"/>
                                        <field name="item_name"/>
                                        <field name="quantity" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="currency_code"/>
                                        <field name="line_extension_amount" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="allowance_amount" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="line_extension_amount_try" string="Tutar (TRY)" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="allowance_amount_try" string="İndirim (TRY)" widget="float" options="{'digits': [16, 2]}"/>
                                    </list>
                                </field>
                            </page>
                            <!-- Vergiler -->
                            <page string="Vergiler" name="taxes">
                                <field name="tax_ids" readonly="1">
                                    <list>
                                        <field name="tax_type"/>
                                        <field name="percent" widget="float" options="{'digits': [5, 2]}"/>
                                        <field name="currency_code"/>
                                        <field name="taxable_amount" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="tax_amount" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="taxable_amount_try" string="Matrah (TRY)" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="tax_amount_try" string="Vergi (TRY)" widget="float" options="{'digits': [16, 2]}"/>
                                    </list>
                                </field>
                            </page>
                            <!-- Notlar -->
                            <page string="Notlar" name="notes">
                                <field name="note_ids" readonly="1">
                                    <list>
                                        <field name="sequence" widget="handle"/>
                                        <field name="note_type"/>
                                        <field name="key"/>
                                        <field name="value"/>
                                    </list>
                                </field>
                            </page>
                            <!-- Durum Bilgileri -->
                            <page string="Durum Bilgileri" name="status">
                                <group>
                                    <group string="SOAP Durumu">
                                        <field name="status_code" readonly="1"/>
                                        <field name="status_description" readonly="1"/>
                                        <field name="response_code" readonly="1"/>
                                    </group>
                                    <group string="İptal Bilgileri">
                                        <field name="gvn_active" readonly="1"/>
                                        <field name="is_cancellation" readonly="1"/>
                                        <field name="cancelled_invoice_id" readonly="1"/>
                                        <field name="harici_iptal" readonly="1"/>
                                    </group>
                                </group>
                                <separator string="İptal Faturaları"/>
                                <field name="cancellation_ids" readonly="1" nolabel="1">
                                    <list>
                                        <field name="invoice_id"/>
                                        <field name="issue_date"/>
                                        <field name="sender_name"/>
                                    </list>
                                </field>
                            </page>
                            <!-- Logo Eşleştirme -->
                            <page string="Logo" name="logo">
                                <group>
                                    <group string="E-Fatura Bilgileri">
                                        <field name="sender" readonly="1"/>
                                        <field name="sender_name" readonly="1"/>
                                        <field name="receiver" readonly="1"/>
                                        <field name="receiver_name" readonly="1"/>
                                        <field name="payable_amount_try" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                    </group>
                                    <group string="Logo Eşleşme Bilgileri">
                                        <field name="logo_fatura_count" readonly="1"/>
                                        <field name="logo_mssql_id" readonly="1"/>
                                        <field name="logo_fatura_tarihi" readonly="1"/>
                                        <field name="logo_fatura_tutari" readonly="1" widget="float" options="{'digits': [16, 2]}"/>
                                    </group>
                                </group>
                                <field name="logo_karsilastirma_html" readonly="1" nolabel="1"/>
                                <field name="logo_notes" readonly="1"/>
                                <separator string="Eşleşen Logo Faturaları"/>
                                <field name="logo_fatura_ids" readonly="1" nolabel="1">
                                    <list>
                                        <field name="fatura_no_1"/>
                                        <field name="fatura_no_2"/>
                                        <field name="fatura_tipi"/>
                                        <field name="fatura_tarihi_1"/>
                                        <field name="fatura_tutari" widget="float" options="{'digits': [16, 2]}"/>
                                        <field name="vkn"/>
                                        <field name="tckn"/>
                                        <field name="iptal_durumu"/>
                                    </list>
                                </field>
                            </page>
                            <!-- Teknik -->
                            <page string="Teknik" name="technical" groups="guven_fatura_analiz.group_muhasebe_yoneticisi">
                                <group>
                                    <group string="Kilit Bilgileri">
                                        <field name="is_locked"/>
                                        <field name="locked_by_id"/>
                                        <field name="locked_date"/>
                                        <field name="lock_reason"/>
                                    </group>
                                </group>
                                <group string="Detay Durumu">
                                    <field name="details_received" readonly="1"/>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- LOGO EŞLEŞTIRME — LIST VIEW                                  -->
        <!-- ============================================================ -->
        <record id="guven_fatura_logo_eslestirme_view_list" model="ir.ui.view">
            <field name="name">guven.fatura.logo.eslestirme.list</field>
            <field name="model">guven.fatura</field>
            <field name="arch" type="xml">
                <list string="GİB → Logo Eşleştirme"
                      class="o_logo_eslestirme"
                      default_order="issue_date desc, invoice_id desc"
                      decoration-success="logo_fatura_count == 1 and not tutar_farki_var and not vkn_farkli and not tckn_farkli and not fatura_tarihi_farkli"
                      decoration-danger="logo_fatura_count != 1 or tutar_farki_var or vkn_farkli or tckn_farkli or fatura_tarihi_farkli"
                      create="0" delete="0">
                    <field name="direction"/>
                    <field name="kaynak"/>
                    <field name="invoice_id"/>
                    <field name="issue_date"/>
                    <field name="payable_amount_try" string="GİB Tutar (TRY)" widget="float" options="{'digits': [16, 2]}"/>
                    <field name="logo_fatura_count" string="Eşleşme"/>
                    <field name="tutar_farki_var" string="Tutar ✗" widget="boolean"/>
                    <field name="tutar_farki" string="Tutar Farkı" widget="float" options="{'digits': [16, 2]}"/>
                    <field name="vkn_farkli" string="VKN ✗" widget="boolean"/>
                    <field name="tckn_farkli" string="TCKN ✗" widget="boolean"/>
                    <field name="fatura_tarihi_farkli" string="Tarih ✗" widget="boolean"/>
                    <field name="logo_fatura_tarihi"/>
                    <field name="logo_fatura_tutari" string="Logo Tutar" widget="float" options="{'digits': [16, 2]}"/>
                    <field name="logo_fatura_vkn"/>
                    <field name="logo_fatura_tckn"/>
                </list>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- LOGO EŞLEŞTIRME — SEARCH VIEW                                -->
        <!-- ============================================================ -->
        <record id="guven_fatura_logo_eslestirme_view_search" model="ir.ui.view">
            <field name="name">guven.fatura.logo.eslestirme.search</field>
            <field name="model">guven.fatura</field>
            <field name="arch" type="xml">
                <search string="Logo Eşleştirme Arama">
                    <field name="invoice_id" string="Fatura No"/>
                    <field name="sender_name" string="Gönderen"/>
                    <field name="receiver_name" string="Alıcı"/>
                    <separator/>
                    <filter name="filter_unmatched" string="Hiç Eşi Olmayanlar" domain="[('logo_fatura_count', '=', 0)]"/>
                    <filter name="filter_single" string="Bire-Bir Eşleşenler" domain="[('logo_fatura_count', '=', 1)]"/>
                    <filter name="filter_multi" string="Çoklu Eşi Olanlar" domain="[('logo_fatura_count', '&gt;', 1)]"/>
                    <separator/>
                    <filter name="filter_tutar_farki" string="Tutar Farkı" domain="[('tutar_farki_var', '=', True)]"/>
                    <filter name="filter_vkn_farkli" string="VKN Farklı" domain="[('vkn_farkli', '=', True)]"/>
                    <filter name="filter_tckn_farkli" string="TCKN Farklı" domain="[('tckn_farkli', '=', True)]"/>
                    <filter name="filter_tarih_farkli" string="Tarih Farklı" domain="[('fatura_tarihi_farkli', '=', True)]"/>
                    <separator/>
                    <filter name="filter_incoming" string="Gelen" domain="[('direction', '=', 'IN')]"/>
                    <filter name="filter_outgoing" string="Giden" domain="[('direction', '=', 'OUT')]"/>
                    <separator/>
                    <filter name="filter_efatura" string="E-Fatura" domain="[('kaynak', '=', 'e-fatura')]"/>
                    <filter name="filter_earsiv" string="E-Arşiv" domain="[('kaynak', '=', 'e-arsiv')]"/>
                    <separator/>
                    <filter name="filter_month_01" string="Ocak"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=1, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=1, day=31)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_02" string="Şubat"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=2, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=2, day=31)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_03" string="Mart"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=3, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=3, day=31)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_04" string="Nisan"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=4, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=4, day=30)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_05" string="Mayıs"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=5, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=5, day=31)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_06" string="Haziran"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=6, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=6, day=30)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_07" string="Temmuz"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=7, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=7, day=31)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_08" string="Ağustos"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=8, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=8, day=31)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_09" string="Eylül"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=9, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=9, day=30)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_10" string="Ekim"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=10, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=10, day=31)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_11" string="Kasım"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=11, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=11, day=30)).strftime('%Y-%m-%d'))]"/>
                    <filter name="filter_month_12" string="Aralık"
                            domain="[('issue_date', '&gt;=', (context_today() + relativedelta(month=12, day=1)).strftime('%Y-%m-%d')),
                                     ('issue_date', '&lt;=', (context_today() + relativedelta(month=12, day=31)).strftime('%Y-%m-%d'))]"/>
                    <group>
                        <filter name="group_direction" string="Yön" context="{'group_by': 'direction'}"/>
                        <filter name="group_kaynak" string="Kaynak" context="{'group_by': 'kaynak'}"/>
                        <filter name="group_issue_date" string="Fatura Tarihi (Ay)" context="{'group_by': 'issue_date:month'}"/>
                        <filter name="group_tutar_farki" string="Tutar Farkı Var" context="{'group_by': 'tutar_farki_var'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ============================================================ -->
        <!-- LOGO EŞLEŞTIRME — ACTION                                     -->
        <!-- ============================================================ -->
        <record id="action_guven_fatura_logo_eslestirme" model="ir.actions.act_window">
            <field name="name">GİB → Logo Eşleştirme</field>
            <field name="res_model">guven.fatura</field>
            <field name="view_mode">list,form</field>
            <field name="view_ids" eval="[
                (5, 0, 0),
                (0, 0, {'view_mode': 'list', 'view_id': ref('guven_fatura_logo_eslestirme_view_list')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('guven_fatura_view_form')}),
            ]"/>
            <field name="search_view_id" ref="guven_fatura_logo_eslestirme_view_search"/>
            <field name="domain">[('gvn_active', '=', True)]</field>
        </record>

        <!-- ============================================================ -->
        <!-- ACTION                                                        -->
        <!-- ============================================================ -->
        <record id="action_guven_fatura" model="ir.actions.act_window">
            <field name="name">Faturalar</field>
            <field name="res_model">guven.fatura</field>
            <field name="view_mode">list,form</field>
            <field name="search_view_id" ref="guven_fatura_view_search"/>
            <field name="context">{'search_default_filter_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Henüz fatura kaydı bulunmuyor.
                </p>
                <p>
                    E-Fatura ve E-Arşiv faturalarını senkronize etmek için SOAP entegrasyonunu kullanın.
                </p>
            </field>
        </record>

    </data>
</odoo>
